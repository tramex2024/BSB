<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Funcional con Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Usamos la fuente Inter para un aspecto moderno */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .task-item {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app" class="w-full max-w-xl bg-white shadow-xl rounded-xl p-6 md:p-8">

        <h1 class="text-3xl font-bold text-gray-800 mb-2">Mi Aplicación Funcional</h1>
        <p class="text-sm text-gray-500 mb-6">Lista de Tareas (Datos Privados de Firestore)</p>

        <!-- Mensajes de Estado/Carga -->
        <div id="statusMessage" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
            <p class="font-semibold">Iniciando aplicación y autenticación...</p>
        </div>

        <!-- Contenido Principal de la Aplicación (Visible solo tras el "login" exitoso) -->
        <div id="mainApp" class="hidden">
            <!-- Info de Usuario -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6 shadow-inner text-sm">
                <p class="font-semibold text-gray-700">Usuario Autenticado (ID):</p>
                <code id="userIdDisplay" class="break-all text-purple-600">Cargando...</code>
            </div>

            <!-- Formulario para Añadir Tarea -->
            <div class="flex gap-2 mb-8">
                <input type="text" id="taskInput" placeholder="Añadir nueva tarea..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <button id="addTaskButton"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50"
                        disabled>
                    Añadir
                </button>
            </div>

            <!-- Lista de Tareas -->
            <div id="taskList" class="space-y-3">
                <p class="text-gray-400 text-center mt-4" id="emptyState">No hay tareas aún. ¡Añade una!</p>
                <!-- Las tareas se inyectarán aquí -->
            </div>
        </div>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Activamos los logs de debug para facilitar la depuración
        setLogLevel('debug');

        // --- Variables Globales Proporcionadas por el Entorno (¡OBLIGATORIAS!) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false; // Bandera para saber si la autenticación ha finalizado

        // --- Referencias del DOM ---
        const statusMessageEl = document.getElementById('statusMessage');
        const mainAppEl = document.getElementById('mainApp');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const taskInputEl = document.getElementById('taskInput');
        const addTaskButtonEl = document.getElementById('addTaskButton');
        const taskListEl = document.getElementById('taskList');
        const emptyStateEl = document.getElementById('emptyState');

        // --- Utilidades ---

        /** Muestra un mensaje de estado en la UI (en lugar de alert()) */
        function displayMessage(message, type = 'info') {
            let bgColor, borderColor, textColor;
            switch (type) {
                case 'success':
                    [bgColor, borderColor, textColor] = ['bg-green-100', 'border-green-500', 'text-green-700'];
                    break;
                case 'error':
                    [bgColor, borderColor, textColor] = ['bg-red-100', 'border-red-500', 'text-red-700'];
                    break;
                case 'info':
                default:
                    [bgColor, borderColor, textColor] = ['bg-blue-100', 'border-blue-500', 'text-blue-700'];
                    break;
            }
            statusMessageEl.className = `${bgColor} border-l-4 ${borderColor} ${textColor} p-4 rounded-lg mb-6`;
            statusMessageEl.innerHTML = `<p class="font-semibold">${message}</p>`;
            if (type !== 'info') {
                // Ocultar mensaje de estado después de un tiempo si no es de carga
                setTimeout(() => statusMessageEl.classList.add('hidden'), 5000);
            } else {
                statusMessageEl.classList.remove('hidden');
            }
        }

        /** Inicializa Firebase y maneja la autenticación */
        async function initFirebaseAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config no está disponible.");
                displayMessage("Error: La configuración de Firebase no está disponible.", 'error');
                return;
            }

            try {
                // 1. Inicializar servicios
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. Establecer el observador de estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = userId;
                        
                        // Autenticación exitosa (el "login" funcionó)
                        displayMessage(`¡Bienvenido! Autenticación exitosa. User ID: ${userId}`, 'success');
                        statusMessageEl.classList.add('hidden'); // Ocultar mensaje de estado
                        mainAppEl.classList.remove('hidden'); // Mostrar la aplicación principal
                        addTaskButtonEl.disabled = false;
                        
                        // Una vez autenticado, iniciar el listener de Firestore
                        setupFirestoreListener(); 

                    } else {
                        userId = null;
                        displayMessage("Esperando autenticación...", 'info');
                        mainAppEl.classList.add('hidden');
                        addTaskButtonEl.disabled = true;
                    }
                });

                // 3. Intentar iniciar sesión con el token personalizado o de forma anónima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                displayMessage(`Error de autenticación: ${error.message}`, 'error');
            }
        }

        // --- Lógica de Firestore ---

        /** Obtiene la ruta de la colección de tareas privada del usuario */
        function getTasksCollectionRef() {
            if (!userId || !db) return null;
            // Estructura de datos privada: /artifacts/{appId}/users/{userId}/tasks
            const userDocPath = `artifacts/${appId}/users/${userId}`;
            return collection(db, userDocPath, 'tasks');
        }

        /** Añade una nueva tarea a Firestore */
        async function addTask() {
            const taskText = taskInputEl.value.trim();
            if (!taskText || !isAuthReady || !userId) {
                displayMessage("Asegúrate de escribir una tarea y de que la app esté lista.", 'error');
                return;
            }

            try {
                const tasksRef = getTasksCollectionRef();
                if (!tasksRef) throw new Error("Referencia de colección no disponible.");

                await addDoc(tasksRef, {
                    text: taskText,
                    completed: false,
                    createdAt: Date.now()
                });

                taskInputEl.value = ''; // Limpiar input
            } catch (e) {
                console.error("Error al añadir tarea: ", e);
                displayMessage(`Error al guardar: ${e.message}`, 'error');
            }
        }

        /** Cambia el estado 'completed' de una tarea */
        async function toggleTask(taskId, isCompleted) {
            try {
                const tasksRef = getTasksCollectionRef();
                if (!tasksRef) throw new Error("Referencia de colección no disponible.");

                const taskDocRef = doc(tasksRef, taskId);
                await updateDoc(taskDocRef, {
                    completed: !isCompleted
                });
            } catch (e) {
                console.error("Error al actualizar tarea: ", e);
                displayMessage(`Error al actualizar: ${e.message}`, 'error');
            }
        }

        /** Elimina una tarea */
        async function deleteTask(taskId) {
             try {
                const tasksRef = getTasksCollectionRef();
                if (!tasksRef) throw new Error("Referencia de colección no disponible.");

                const taskDocRef = doc(tasksRef, taskId);
                await deleteDoc(taskDocRef);
            } catch (e) {
                console.error("Error al eliminar tarea: ", e);
                displayMessage(`Error al eliminar: ${e.message}`, 'error');
            }
        }

        /** Renderiza la lista de tareas en el DOM */
        function renderTasks(tasks) {
            taskListEl.innerHTML = ''; // Limpiar lista
            if (tasks.length === 0) {
                emptyStateEl.classList.remove('hidden');
                return;
            }
            emptyStateEl.classList.add('hidden');

            tasks.sort((a, b) => a.createdAt - b.createdAt); // Ordenar por fecha de creación

            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = `task-item flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm border ${task.completed ? 'border-green-300 line-through text-gray-500' : 'border-gray-200 text-gray-800'}`;
                item.dataset.id = task.id;

                const textSpan = document.createElement('span');
                textSpan.textContent = task.text;

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'flex items-center space-x-3';

                // Botón/Toggle para completar
                const toggleButton = document.createElement('button');
                toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 ${task.completed ? 'text-green-600 hover:text-green-700' : 'text-gray-400 hover:text-gray-600'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="${task.completed ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M10 14l2-2m0 0l2-2m-2 2v2m-2-2h4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}" />
                </svg>`;
                toggleButton.onclick = () => toggleTask(task.id, task.completed);

                // Botón para eliminar
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-400 hover:text-red-600 transition duration-150" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>`;
                deleteButton.onclick = () => deleteTask(task.id);

                controlsDiv.appendChild(toggleButton);
                controlsDiv.appendChild(deleteButton);

                item.appendChild(textSpan);
                item.appendChild(controlsDiv);
                taskListEl.appendChild(item);
            });
        }

        /** Configura el listener de tiempo real de Firestore (onSnapshot) */
        function setupFirestoreListener() {
            const tasksRef = getTasksCollectionRef();
            if (!tasksRef) {
                console.error("No se pudo obtener la referencia de Firestore.");
                return;
            }

            // Crear un query simple (sin orderBy, para evitar errores de índice)
            const tasksQuery = query(tasksRef);

            // onSnapshot se ejecutará en tiempo real ante cualquier cambio
            onSnapshot(tasksQuery, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                renderTasks(tasks);
            }, (error) => {
                console.error("Error en el listener de Firestore:", error);
                displayMessage(`Error de conexión a la base de datos: ${error.message}`, 'error');
            });
        }

        // --- Event Listeners ---
        addTaskButtonEl.addEventListener('click', addTask);
        taskInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        // --- Inicio de la Aplicación ---
        window.onload = initFirebaseAndAuth;

    </script>
</body>
</html>