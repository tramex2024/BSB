// server/seeders/seed.js

const mongoose = require('mongoose');
const dotenv = require('dotenv');
const User = require('../models/User'); 
const Autobot = require('../models/Autobot'); 
const Order = require('../models/Order'); // Nuevo modelo incluido

// Carga las variables de entorno
dotenv.config();

// La conexión a la DB
const connectDB = async () => {
    try {
        await mongoose.connect(process.env.MONGO_URI);
        console.log('MongoDB Connected for Seeding...');
    } catch (err) {
        console.error('MongoDB connection error during seeding:', err.message);
        process.exit(1);
    }
};

const seedDatabase = async () => {
    try {
        await connectDB();

        console.log('--- Iniciando Seeding ---');

        // 1. Borrar colecciones existentes para empezar de nuevo
        await User.deleteMany({});
        await Autobot.deleteMany({});
        await Order.deleteMany({}); // Vaciamos la colección de órdenes
        console.log('Colecciones User, Autobot y Order vaciadas.');

        // 2. Crear el Usuario Inicial
        const emailUsuario = 'tramex2024@gmail.com';
        
        // Token de un solo uso para el primer login
        const tokenInicial = '123456'; 
        const tokenExpires = Date.now() + 60 * 60 * 1000; // Válido por 60 minutos

        const user = new User({ 
            email: emailUsuario,
            token: tokenInicial,
            tokenExpires: tokenExpires
        });

        await user.save();
        console.log(`Usuario principal creado: ${emailUsuario}`);
        console.log(`¡USA ESTE TOKEN PARA EL PRIMER LOGIN: ${tokenInicial}!`);

        // 3. Crear el Documento Inicial de Autobot
        const autobotState = new Autobot({
            symbol: 'BTC_USDT',
            lstate: 'STOPPED',
            sstate: 'STOPPED',
            lbalance: 0.00,
            sbalance: 0.00,
            ltprice: 0.00,
            stprice: 0.00,
            total_profit: 0.00,
            // Configuración base
            config: {
                long: {
                    purchaseUsdt: 5.00,
                    price_var: 1.5,
                    size_var: 100.0,
                    profit_percent: 1.5
                },
                short: {
                    sellBtc: 0.00005,
                    price_var: 1.5,
                    size_var: 100.0,
                    profit_percent: 1.5
                }
            }
        });

        await autobotState.save();
        console.log('Documento inicial de Autobot creado.');

        console.log('--- Seeding Completado Exitosamente. ---');

    } catch (error) {
        console.error('Error durante el seeding:', error);
    } finally {
        // Cierra la conexión de MongoDB
        mongoose.connection.close();
    }
};

seedDatabase();